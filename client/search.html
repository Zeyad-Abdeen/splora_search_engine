<!-- search.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Search Results - My Search Engine</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="search-result-area">
      <a href="index.html">
        <img class="search-logo-result" src="images/splora_search.png" />
      </a>

      <form
        class="search-form"
        id="search-form"
        action="search.html"
        method="get"
        autocomplete="off"
      >
        <div class="search-form-input">
          <input type="text" name="search" id="search-input" />
          <img class="mic" src="./images/google_mic.svg" />
          <img class="camera" src="./images/google_camera.svg" />
          <img
            class="search-icon-result"
            src="./images/google_search_icon.svg"
          />
        </div>
      </form>
    </div>
    <div id="results"></div>
    <div id="pagination"></div>
    <script>
      // Get the query parameter from the URL
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('search');
      document.getElementById('search-input').value = query;
      let page = parseInt(urlParams.get('page')) || 1;
      const numResults = 10; // Adjust as needed

      // Add pagination controls
      function addPaginationControls(totalResults) {
        const paginationDiv = document.getElementById('pagination');
        paginationDiv.innerHTML = ''; // Clear any existing pagination controls

        if (page > 1) {
          const prevLink = document.createElement('a');
          prevLink.href = `search.html?search=${encodeURIComponent(
            query
          )}&page=${page - 1}`;
          prevLink.textContent = 'Previous';
          paginationDiv.appendChild(prevLink);
        }

        if (totalResults === numResults) {
          const nextLink = document.createElement('a');
          nextLink.href = `search.html?search=${encodeURIComponent(
            query
          )}&page=${page + 1}`;
          nextLink.textContent = 'Next';
          paginationDiv.appendChild(nextLink);
        }
      }

      // Function to truncate text to a specific word count
      function truncateText(text, maxWords) {
        const words = text.split(' ');
        if (words.length > maxWords) {
          return words.slice(0, maxWords).join(' ') + '...';
        }
        return text;
      }

      // Function to fetch and display search results
      async function fetchResults() {
        try {
          const response = await fetch(
            `http://127.0.0.1:8080/search?q=${encodeURIComponent(
              query
            )}&page=${page}&num_results=${numResults}`
          );
          const data = await response.json();

          const resultsDiv = document.getElementById('results');

          if (data.results.length === 0) {
            resultsDiv.innerHTML = `<p>No results found for "<strong>${query}</strong>".</p>`;
            return;
          }

          data.results.forEach((result) => {
            const resultDiv = document.createElement('div');
            resultDiv.classList.add('result');

            const titleLink = document.createElement('a');
            titleLink.classList.add('result-title');
            titleLink.href = result.url;
            titleLink.target = '_blank'; // Open in new tab
            titleLink.textContent = result.title || result.url;

            const urlDiv = document.createElement('div');
            urlDiv.classList.add('result-url');
            urlDiv.textContent = result.url;

            // Publication date
            if (result.publication_date) {
              const dateDiv = document.createElement('div');
              dateDiv.classList.add('result-date');
              dateDiv.textContent = `Published: ${result.publication_date}`;
              resultDiv.appendChild(titleLink);
              resultDiv.appendChild(urlDiv);
              resultDiv.appendChild(dateDiv);
            } else {
              resultDiv.appendChild(titleLink);
              resultDiv.appendChild(urlDiv);
            }

            // Authors
            if (result.authors && result.authors.length > 0) {
              const authorsDiv = document.createElement('div');
              authorsDiv.classList.add('result-authors');
              const maxAuthors = 5; // Show only first 5 authors
              const authorList = result.authors.slice(0, maxAuthors);
              const authorsText = authorList.join(', ') + 
                (result.authors.length > maxAuthors ? `, et al. (${result.authors.length} total)` : '');
              authorsDiv.innerHTML = `<strong>Authors:</strong> ${authorsText}`;
              resultDiv.appendChild(authorsDiv);
            }

            // Abstract (use abstract if available, otherwise description)
            const descriptionDiv = document.createElement('div');
            descriptionDiv.classList.add('result-description');
            const contentText = result.abstract || result.description || '';
            descriptionDiv.textContent = truncateText(contentText, 50); // Limit to 50 words
            
            if (contentText) {
              resultDiv.appendChild(descriptionDiv);
            }

            // PageRank score (for debugging, can be removed in production)
            if (result.pagerank) {
              const scoreDiv = document.createElement('div');
              scoreDiv.classList.add('result-score');
              scoreDiv.textContent = `Relevance Score: ${result.pagerank.toFixed(3)}`;
              scoreDiv.style.fontSize = '0.8em';
              scoreDiv.style.color = '#666';
              resultDiv.appendChild(scoreDiv);
            }

            // Summarize button
            const buttonContainer = document.createElement('div');
            buttonContainer.classList.add('button-container');
            buttonContainer.style.marginTop = '10px';

            const summarizeBtn = document.createElement('button');
            summarizeBtn.classList.add('summarize-btn');
            summarizeBtn.textContent = 'Summarize Article';
            summarizeBtn.style.padding = '8px 16px';
            summarizeBtn.style.backgroundColor = '#1a73e8';
            summarizeBtn.style.color = 'white';
            summarizeBtn.style.border = 'none';
            summarizeBtn.style.borderRadius = '4px';
            summarizeBtn.style.cursor = 'pointer';
            summarizeBtn.style.fontSize = '14px';

            // Add hover effect
            summarizeBtn.addEventListener('mouseenter', () => {
              summarizeBtn.style.backgroundColor = '#1557b0';
            });
            summarizeBtn.addEventListener('mouseleave', () => {
              summarizeBtn.style.backgroundColor = '#1a73e8';
            });

            // Add click handler for summarize
            summarizeBtn.addEventListener('click', async () => {
              summarizeBtn.disabled = true;
              summarizeBtn.textContent = 'Summarizing...';
              
              try {
                const response = await fetch('http://127.0.0.1:8080/summarise', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    url: result.url,
                    title: result.title
                  })
                });
                
                const data = await response.json();
                
                if (data.summary) {
                  // Create summary display
                  const summaryDiv = document.createElement('div');
                  summaryDiv.classList.add('summary-content');
                  summaryDiv.style.marginTop = '10px';
                  summaryDiv.style.padding = '15px';
                  summaryDiv.style.backgroundColor = '#f8f9fa';
                  summaryDiv.style.border = '1px solid #e0e0e0';
                  summaryDiv.style.borderRadius = '4px';
                  summaryDiv.innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: #1a73e8;">Article Summary:</h4>
                    <p style="margin: 0; line-height: 1.5;">${data.summary}</p>
                  `;
                  
                  // Insert summary after the button
                  buttonContainer.parentNode.insertBefore(summaryDiv, buttonContainer.nextSibling);
                  
                  // Update button text
                  summarizeBtn.textContent = 'Summary Generated';
                  summarizeBtn.style.backgroundColor = '#34a853';
                } else {
                  throw new Error(data.error || 'Failed to generate summary');
                }
                
              } catch (error) {
                console.error('Error summarizing article:', error);
                summarizeBtn.textContent = 'Summary Failed - Try Again';
                summarizeBtn.style.backgroundColor = '#ea4335';
                setTimeout(() => {
                  summarizeBtn.textContent = 'Summarize Article';
                  summarizeBtn.style.backgroundColor = '#1a73e8';
                  summarizeBtn.disabled = false;
                }, 3000);
              }
            });

            buttonContainer.appendChild(summarizeBtn);
            resultDiv.appendChild(buttonContainer);

            resultsDiv.appendChild(resultDiv);
          });

          // Add pagination controls
          addPaginationControls(data.results.length);
        } catch (error) {
          console.error('Error fetching search results:', error);
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = `<p>Error loading search results. Please try again later.</p>`;
        }
      }

      // Fetch and display results when the page loads
      fetchResults();
    </script>
  </body>
</html>